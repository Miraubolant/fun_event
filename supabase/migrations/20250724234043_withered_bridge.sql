-- V√©rification des tables et politiques RLS
-- Cette migration aide √† diagnostiquer les probl√®mes d'insertion

-- 1. V√©rifier que les tables existent
DO $$
BEGIN
    -- V√©rifier la table categories
    IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'categories') THEN
        RAISE NOTICE 'Table categories existe ‚úÖ';
    ELSE
        RAISE NOTICE 'Table categories MANQUANTE ‚ùå';
    END IF;
    
    -- V√©rifier la table structures
    IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'structures') THEN
        RAISE NOTICE 'Table structures existe ‚úÖ';
    ELSE
        RAISE NOTICE 'Table structures MANQUANTE ‚ùå';
    END IF;
    
    -- V√©rifier la table carousel_photos
    IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'carousel_photos') THEN
        RAISE NOTICE 'Table carousel_photos existe ‚úÖ';
    ELSE
        RAISE NOTICE 'Table carousel_photos MANQUANTE ‚ùå';
    END IF;
END $$;

-- 2. V√©rifier les politiques RLS
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual,
    with_check
FROM pg_policies 
WHERE tablename IN ('categories', 'structures', 'carousel_photos')
ORDER BY tablename, policyname;

-- 3. V√©rifier le statut RLS
SELECT 
    schemaname,
    tablename,
    rowsecurity
FROM pg_tables 
WHERE tablename IN ('categories', 'structures', 'carousel_photos');

-- 4. Corriger les politiques si n√©cessaire
-- Supprimer les anciennes politiques
DROP POLICY IF EXISTS "Anyone can read categories" ON categories;
DROP POLICY IF EXISTS "Authenticated users can modify categories" ON categories;
DROP POLICY IF EXISTS "Anyone can read structures" ON structures;
DROP POLICY IF EXISTS "Authenticated users can modify structures" ON structures;
DROP POLICY IF EXISTS "Anyone can read carousel photos" ON carousel_photos;
DROP POLICY IF EXISTS "Authenticated users can modify carousel photos" ON carousel_photos;

-- Cr√©er des politiques plus permissives pour le diagnostic
CREATE POLICY "Public read categories" ON categories FOR SELECT TO public USING (true);
CREATE POLICY "Public write categories" ON categories FOR ALL TO public USING (true) WITH CHECK (true);

CREATE POLICY "Public read structures" ON structures FOR SELECT TO public USING (true);
CREATE POLICY "Public write structures" ON structures FOR ALL TO public USING (true) WITH CHECK (true);

CREATE POLICY "Public read carousel_photos" ON carousel_photos FOR SELECT TO public USING (true);
CREATE POLICY "Public write carousel_photos" ON carousel_photos FOR ALL TO public USING (true) WITH CHECK (true);

-- 5. Tenter une insertion de test
DO $$
BEGIN
    -- Test insertion cat√©gorie
    BEGIN
        INSERT INTO categories (id, label, icon) 
        VALUES ('test-category-id', 'Test Category', 'üß™')
        ON CONFLICT (id) DO NOTHING;
        RAISE NOTICE 'Test insertion cat√©gorie: SUCCESS ‚úÖ';
    EXCEPTION WHEN OTHERS THEN
        RAISE NOTICE 'Test insertion cat√©gorie: FAILED ‚ùå - %', SQLERRM;
    END;
    
    -- Test insertion structure
    BEGIN
        INSERT INTO structures (id, name, category_id, size, capacity, age, price, image, description, available) 
        VALUES ('test-structure-id', 'Test Structure', 'test-category-id', '1x1', '1 personne', '3-99 ans', 50, 'https://example.com/test.jpg', 'Test description', true)
        ON CONFLICT (id) DO NOTHING;
        RAISE NOTICE 'Test insertion structure: SUCCESS ‚úÖ';
    EXCEPTION WHEN OTHERS THEN
        RAISE NOTICE 'Test insertion structure: FAILED ‚ùå - %', SQLERRM;
    END;
    
    -- Test insertion photo
    BEGIN
        INSERT INTO carousel_photos (id, url, alt, order_position) 
        VALUES ('test-photo-id', 'https://example.com/test.jpg', 'Test photo', 1)
        ON CONFLICT (id) DO NOTHING;
        RAISE NOTICE 'Test insertion photo: SUCCESS ‚úÖ';
    EXCEPTION WHEN OTHERS THEN
        RAISE NOTICE 'Test insertion photo: FAILED ‚ùå - %', SQLERRM;
    END;
END $$;

-- 6. Nettoyer les donn√©es de test
DELETE FROM structures WHERE id = 'test-structure-id';
DELETE FROM categories WHERE id = 'test-category-id';
DELETE FROM carousel_photos WHERE id = 'test-photo-id';

RAISE NOTICE 'Diagnostic termin√© - V√©rifiez les logs ci-dessus';